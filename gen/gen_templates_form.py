from .gen_functions             import print_log
# General variables
from gen.gen_functions          import Dash,Do_not_modify,Dash_Jinja,Do_not_modify_Jinja
from gen.gen_menu_functions     import auto_templates

def Gen_Templates_Form(Metadata,Tab,Chd,app_folder):

    table_name = Tab['table']
    class_name = Tab['class']
    # ------------------------------------------------------------------------
    # Unit Record Template
    # ------------------------------------------------------------------------

    table_name = Tab['table']

    #file_name = app_folder+"/app/templates/"+table_name.lower()+".html"
    file_name = auto_templates+"/"+table_name.lower()+".html"
    print_log("Creating '%s'..."%(file_name))
    f = open(file_name,"w")

    f.write('{% extends "base.html" %}\n')
    f.write('{% import "bootstrap/wtf.html" as wtf %}\n')
    # GV 20181110 code for pagination -->
    #f.write('{% import "_macros.html" as macros %}\n\n')
    # GV 20181110 <--

    f.write('{% block title %}Collector{% endblock %}\n')

    f.write('{% block head %}\n')
    f.write('{{ super() }}\n')
    f.write('{% endblock %}\n')

    f.write('{% block page_content %}\n')
    f.write('<!-- ------------------ -->\n')
    f.write('<!-- gen_templates_form -->\n')
    f.write('<!-- ------------------ -->\n')
    
    # FLASH Generation Code (Promoted to base.html generated by gen_collector_menu.py
    #f.write('{% with messages = get_flashed_messages() %}\n')
    #f.write('  {% if messages %}\n')
    #f.write('    <ul class=flashes>\n')
    #f.write('    {% for message in messages %}\n')
    #f.write('      <li>{{ message }}</li>\n')
    #f.write('    {% endfor %}\n')
    #f.write('    </ul>\n')
    #f.write('  {% endif %}\n')
    #f.write('{% endwith %}\n')

    f.write('<div class="page-header">\n')
    
    if len(Tab['primary_key_auto_increment'])>0:
        f.write('    <h2>%s: {{ row.%s }}</h2>\n'%(Tab['entity'],Tab['primary_key_auto_increment']))
    else:
        f.write('    <h2>%s: </h2>\n'%(Tab['entity']))

    f.write(    '    <a href="#" onclick="history.go(-1)"><img src="/static/img/back.png"  color=yellow width="32" height="32" title="" alt="Add"></a>\n')        
    
    f.write('</div>\n')
    
    
    # FORM Rendering Code
    f.write('{{ wtf.quick_form(form) }}\n')
    
    # Conditional code includes Child Data Table
    
    if Tab['has_child']:

        f.write(    '<hr>\n')
        f.write(    '<div>\n')
        f.write(    '<h2>%s(s) found {{row.%s.__len__()}} records</h2>\n' % (
                    #My_Tables[Chd['table']]['caption'],
                    Metadata['tables'][Chd['table']]['caption'],
                    Chd['table'].lower()
                    ))
        f.write(    '   {%% for crow in row.%s %%}\n'%(Chd['table'].lower()))
        f.write(    '   {% if loop.first %}\n')
        f.write(    '       <table class="table">\n')
        f.write(    '           <thead class="thead-dark">\n')
        
        f.write(    '               <tr id="header">\n')

        for c in range(len(Chd['columns'])):
            if Chd['columns'][c] not in Tab['keys']:
                f.write('                   <th>%s</th>\n'%(Chd['headers'][c]))
                
        f.write(    '                           <td><a href="/forms/%s?%s&parent_field=%s&parent_value={{crow.%s}}"><img src="/static/img/add.png"  color=yellow width="32" height="32" title="" alt="Add"></a></td>\n'%(Chd['table'],0,Tab['primary_key_auto_increment'],Tab['primary_key_auto_increment']))        

        f.write(    '               </tr>\n')
        f.write(    '           </thead>\n')
        
        f.write(    '           <tbody>\n')
        f.write(    '   {% endif %}\n')

        f.write(    '       <tr>\n')

        for c in range(len(Chd['columns'])):     
            if Chd['columns'][c] not in Tab['keys']:
                f.write('           <td>{{ crow.%s }}</td>\n'%((Chd['columns'][c])))


        link_keys = ''
        s=''

        for k in Metadata['tables'][Chd['table']]['keys']:
            link_keys = link_keys + "%s{{crow.%s}}"%(s,k)
            s='&'

        f.write('           <td>'\
                                '<a href="/forms/%s?%s=%s"><img src="/static/img/edit.png" width="32" height="32" title="" alt="Edit"></a>\n'%\
                            (   Chd['table'],Metadata['tables'][Chd['table']]['key'] ,link_keys))
        f.write('               <a href="/forms/%s_delete/%s"><img src="/static/img/delete.png" width="32" height="32" title="" alt="Edit"></a></td>\n'%\
                            (   Chd['table'],link_keys) )      


        f.write(    '       </tr>\n')
        f.write(    '    {% endfor %}\n')    
        f.write(    '  </tbody>\n')
        f.write(    '</table>\n')    
        f.write(    '</div>\n')
    
    f.write(    '<hr>\n')
    # GV 20181110 include Pagination code -->
    #f.write(    '<div class="pagination">\n')
    #f.write(    '   {{ macros.pagination_widget(pagination, \'.index\') }}\n')
    #f.write(    '</div>\n')
    # GV 20181110 include Pagination code <--
    f.write('<!-- ------------------ -->\n')
    f.write('<!-- gen_templates_form -->\n')
    f.write('<!-- ------------------ -->\n')   
    f.write('{% endblock %}\n')

    f.write(Dash_Jinja)       
    f.close()



